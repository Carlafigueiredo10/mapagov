# =============================================================================
# MapaGov - Render Deploy (Free Tier + Neon PostgreSQL)
# =============================================================================
# Custo: $0/mês (Render Free + Neon Free)
# Arquitetura: Web Service único servindo Django + React build
# =============================================================================

services:
  - type: web
    name: mapagov
    env: python
    region: oregon
    plan: free
    branch: main

    # Build: Frontend React + Backend Django
    buildCommand: bash build.sh

    # Start: Gunicorn otimizado para Free tier (512MB RAM)
    # 1 worker + 4 threads = menos RAM, mais responsividade
    # Cache de embeddings carrega 1x por worker (não duplica)
    startCommand: gunicorn mapagov.wsgi:application --bind 0.0.0.0:$PORT --workers 1 --threads 4 --timeout 120

    envVars:
      - key: PYTHON_VERSION
        value: "3.11.0"

      - key: DEBUG
        value: "False"

      - key: SECRET_KEY
        generateValue: true

      - key: ALLOWED_HOSTS
        value: mapagov.onrender.com,.onrender.com

      # =========================================
      # CONFIGURAR MANUALMENTE NO DASHBOARD:
      # =========================================

      # DATABASE_URL: Copiar do Neon Dashboard
      # Formato: postgresql://user:pass@ep-xxx.neon.tech/mapagov?sslmode=require
      - key: DATABASE_URL
        sync: false

      # OPENAI_API_KEY: Sua chave da OpenAI
      - key: OPENAI_API_KEY
        sync: false

      # SENTRY_DSN (opcional): Para monitoramento de erros
      - key: SENTRY_DSN
        sync: false

      # =========================================
      # CONFIGURAÇÕES DE PRODUÇÃO
      # =========================================

      - key: CORS_ALLOWED_ORIGINS
        value: "https://mapagov.onrender.com"

      - key: CSRF_TRUSTED_ORIGINS
        value: "https://mapagov.onrender.com"

      # Modo lite: False = busca semântica ativa (embeddings pré-computados)
      # True = pula busca semântica (fallback para dropdown)
      - key: HELENA_LITE_MODE
        value: "False"

      - key: ENVIRONMENT
        value: production

    # Health check na raiz
    healthCheckPath: /
