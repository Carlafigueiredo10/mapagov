<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Helena - Mapeamento de Processos DECIPEX</title>
    {% load static %}
    
    <style>
        * { box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        
        .container {
            width: 100%;
            margin: 0;
            display: flex;
            flex-direction: row;
            gap: 20px;
            height: 100vh;
            padding: 10px;
        }
        
        .chat-section {
            background: white;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            height: 100%;
            flex: 0.45;
        }
        
        .chat-header {
            background: linear-gradient(135deg, #1351B4, #0E4B99);
            color: white;
            padding: 20px;
            text-align: center;
            border-radius: 15px 15px 0 0;
            position: relative;
        }
        
        .chat-header h2 { margin: 0; font-size: 24px; }
        .chat-header p { margin: 10px 0 0 0; opacity: 0.9; font-size: 14px; }
        
        .progress-container {
            margin-top: 15px;
            background: rgba(255,255,255,0.2);
            border-radius: 10px;
            height: 8px;
            overflow: hidden;
        }
        
        .progress-bar {
            height: 100%;
            background: white;
            border-radius: 10px;
            width: 0%;
            transition: width 0.5s ease;
        }
        
        .progress-text {
            font-size: 12px;
            margin-top: 5px;
            opacity: 0.9;
        }
        
        .reset-btn {
            position: absolute;
            top: 15px;
            right: 140px;
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 8px 12px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 12px;
            transition: background 0.3s;
        }
        
        .reset-btn:hover {
            background: rgba(255,255,255,0.3);
        }
        
        .historico-btn {
            position: absolute;
            top: 15px;
            right: 15px;
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 8px 12px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 12px;
            transition: background 0.3s;
        }
        
        .historico-btn:hover {
            background: rgba(255,255,255,0.3);
        }
        
        #chat-container {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .input-section {
            padding: 20px;
            background: #fafafa;
            border-radius: 0 0 15px 15px;
        }
        
        .input-group {
            display: flex;
            gap: 10px;
        }
        
        #user-input {
            flex: 1;
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 25px;
            font-size: 14px;
            outline: none;
        }
        
        #user-input:focus { border-color: #1351B4; }
        
        #enviar-btn {
            background: #1351B4;
            color: white;
            border: none;
            padding: 15px 25px;
            border-radius: 25px;
            cursor: pointer;
            font-weight: bold;
            transition: 0.3s;
        }
        
        #enviar-btn:hover { background: #0E4B99; }
        #enviar-btn:disabled { background: #ccc; cursor: not-allowed; }
        
        #ajuda-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 15px 25px;
            border-radius: 25px;
            cursor: pointer;
            font-weight: bold;
            transition: 0.3s;
        }
        
        #ajuda-btn:hover {
            background: #c82333;
        }
        
        .mensagem {
            padding: 12px 16px;
            border-radius: 12px;
            max-width: 80%;
            word-wrap: break-word;
            line-height: 1.4;
        }
        
        .mensagem.usuario {
            margin-left: auto;
            background: #1351B4;
            color: white;
        }
        
        .mensagem.helena {
            background: #f0f0f0;
            color: #333;
        }
        
        .mensagem.loading {
            opacity: 0.6;
            font-style: italic;
        }
        
        .interface-container {
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            padding: 20px;
            margin: 10px 0;
            max-width: 90%;
        }
        
        .interface-title {
            font-weight: bold;
            margin-bottom: 15px;
            color: #495057;
            font-size: 16px;
        }
        
        .areas-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 10px;
        }
        
        .area-option {
            background: white;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }
        
        .area-option:hover {
            border-color: #1351B4;
            background: #f0f4ff;
        }
        
        .area-option.selected {
            border-color: #1351B4;
            background: #e6efff;
        }
        
        .area-codigo {
            font-weight: bold;
            color: #1351B4;
            font-size: 18px;
        }
        
        .area-nome {
            font-size: 14px;
            margin-top: 5px;
            color: #666;
        }
        
        .sistemas-container {
            margin: 15px 0;
        }
        
        .categoria-sistemas {
            margin-bottom: 20px;
        }
        
        .categoria-titulo {
            font-weight: bold;
            color: #495057;
            margin-bottom: 10px;
            padding: 8px 12px;
            background: #e9ecef;
            border-radius: 6px;
            font-size: 14px;
        }
        
        .sistemas-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 8px;
        }
        
        .sistema-checkbox {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px;
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .sistema-checkbox:hover {
            background: #f8f9fa;
            border-color: #4CAF50;
        }
        
        .sistema-checkbox input[type="checkbox"] {
            margin: 0;
            cursor: pointer;
        }
        
        .sistema-checkbox.selected {
            background: #e8f5e8;
            border-color: #4CAF50;
        }
        
        .norma-sugerida {
            background: linear-gradient(135deg, #fff3cd, #fffaeb) !important;
            border-color: #ff9800 !important;
            position: relative;
        }
        
        .norma-sugerida::before {
            content: "ü§ñ IA";
            position: absolute;
            top: 5px;
            right: 5px;
            background: #ff9800;
            color: white;
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 10px;
            font-weight: bold;
        }
        
        .norma-sugerida:hover {
            background: linear-gradient(135deg, #ffe8a1, #fff3cd) !important;
            border-color: #f57c00 !important;
        }
        
        .operadores-etapa-container {
            margin-top: 15px;
            padding: 15px;
            background: #f0f4ff;
            border: 2px dashed #1351B4;
            border-radius: 8px;
        }
        
        .operadores-etapa-titulo {
            font-weight: bold;
            color: #1351B4;
            margin-bottom: 10px;
            font-size: 14px;
        }
        
        .operadores-etapa-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 8px;
        }
        
        .action-buttons {
            margin-top: 15px;
            display: flex;
            gap: 10px;
            justify-content: center;
        }
        
        .btn-interface {
            padding: 10px 20px;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background: #1351B4;
            color: white;
        }
        
        .btn-primary:hover {
            background: #0E4B99;
        }
        
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #5a6268;
        }
        
        .form-section {
            background: white;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            height: 100%;
            flex: 0.55;
        }
        
        .form-header {
            background: linear-gradient(135deg, #495057, #343a40);
            color: white;
            padding: 20px;
            text-align: center;
            border-radius: 15px 15px 0 0;
            position: relative;
        }
        
        .form-header h2 { margin: 0; font-size: 24px; }
        
        .fields-indicator {
            position: absolute;
            top: 15px;
            right: 15px;
            background: rgba(255,255,255,0.2);
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
        }
        
        .form-content {
            flex: 1;
            padding: 30px;
            overflow-y: auto;
        }
        
        .form-group {
            margin-bottom: 20px;
            position: relative;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #333;
        }
        
        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }
        
        .form-group input:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #495057;
        }
        
        .form-group input.preenchido,
        .form-group textarea.preenchido {
            border-color: #1351B4;
            background: #f0f4ff;
        }
        
        .form-group textarea {
            min-height: 80px;
            resize: vertical;
        }
        
        .validacao-feedback {
            position: absolute;
            right: 45px;
            top: 35px;
            font-size: 18px;
        }
        
        .validacao-feedback.valido {
            color: #1351B4;
        }
        
        .validacao-feedback.invalido {
            color: #f44336;
        }
        
        .form-section-header {
            background: #f8fafc;
            padding: 12px;
            border-radius: 8px;
            margin: 30px 0 20px 0;
        }
        
        .form-section-header h3 {
            margin: 0;
            color: #1B4F72;
            font-size: 16px;
        }
        
        .form-actions {
            padding: 20px 30px;
            background: #fafafa;
            border-radius: 0 0 15px 15px;
            border-top: 1px solid #eee;
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }
        
        .btn-form {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
        }
        
        .btn-form.gerar-pdf {
            background: #ff9800;
            color: white;
        }
        
        .btn-form.gerar-pdf:hover {
            background: #f57c00;
        }
        
        .btn-form.limpar {
            background: #6c757d;
            color: white;
        }
        
        .btn-form.limpar:hover {
            background: #5a6268;
        }
        
        .btn-form.ver-preview {
            background: #1351B4;
            color: white;
        }
        
        .btn-form.ver-preview:hover {
            background: #0E4B99;
        }
        
        .form-section.modo-revisao .form-header {
            background: linear-gradient(135deg, #28a745, #20c997);
            animation: pulseHeader 2s infinite;
        }
        
        @keyframes pulseHeader {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.9; }
        }
        
        .form-section.modo-revisao .form-header h2::before {
            content: "‚úì ";
            color: white;
        }
        
        .form-section.modo-revisao input,
        .form-section.modo-revisao textarea {
            border-color: #28a745;
            background: #f8fff9;
        }
        
        .form-section.modo-revisao input:focus,
        .form-section.modo-revisao textarea:focus {
            border-color: #20c997;
            box-shadow: 0 0 0 3px rgba(40, 167, 69, 0.1);
        }
        
        .btn-gerar-pdf-ativo {
            background: linear-gradient(135deg, #ff9800, #ff6f00) !important;
            animation: pulseBotao 1.5s infinite;
            transform: scale(1.05);
            box-shadow: 0 4px 15px rgba(255, 152, 0, 0.4);
        }
        
        @keyframes pulseBotao {
            0%, 100% { transform: scale(1.05); }
            50% { transform: scale(1.08); }
        }
        
        .modal-preview {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 9999;
            overflow-y: auto;
        }
        
        .modal-preview.ativo {
            display: flex;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.3s ease;
        }
        
        .modal-content-preview {
            background: white;
            width: 90%;
            max-width: 900px;
            max-height: 90vh;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 10px 50px rgba(0, 0, 0, 0.5);
            display: flex;
            flex-direction: column;
        }
        
        .modal-header-preview {
            background: linear-gradient(135deg, #1351B4, #0E4B99);
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-header-preview h2 {
            margin: 0;
            font-size: 20px;
        }
        
        .modal-close {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            font-size: 24px;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            transition: 0.3s;
        }
        
        .modal-close:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        
        .modal-body-preview {
            flex: 1;
            overflow-y: auto;
            padding: 30px;
        }
        
        .preview-secao {
            margin-bottom: 30px;
            page-break-inside: avoid;
        }
        
        .preview-titulo {
            background: #F0F4FF;
            color: #1351B4;
            padding: 12px 15px;
            font-weight: bold;
            border-left: 4px solid #1351B4;
            margin-bottom: 15px;
            font-size: 14px;
        }
        
        .preview-conteudo {
            padding: 10px 15px;
            line-height: 1.6;
            font-size: 12px;
        }
        
        .preview-identificacao {
            text-align: center;
            padding: 20px;
            border-bottom: 3px solid #1351B4;
            margin-bottom: 30px;
        }
        
        .preview-identificacao h1 {
            color: #1351B4;
            font-size: 22px;
            margin-bottom: 10px;
        }
        
        .modal-footer-preview {
            padding: 20px;
            background: #fafafa;
            border-top: 1px solid #eee;
            display: flex;
            gap: 10px;
            justify-content: center;
        }
        
        .btn-modal {
            padding: 12px 30px;
            border: none;
            border-radius: 25px;
            font-weight: bold;
            cursor: pointer;
            transition: 0.3s;
        }
        
        .btn-modal.confirmar {
            background: #ff9800;
            color: white;
        }
        
        .btn-modal.confirmar:hover {
            background: #f57c00;
        }
        
        .btn-modal.voltar {
            background: #6c757d;
            color: white;
        }
        
        .btn-modal.voltar:hover {
            background: #5a6268;
        }
        
        .modal-ajuda {
            display: none;
            position: fixed;
            top: 0;
            right: 0;
            width: 55%;
            height: 100vh;
            background: rgba(0, 0, 0, 0.8);
            z-index: 10000;
            animation: slideInRight 0.3s ease;
        }
        
        @keyframes slideInRight {
            from { transform: translateX(100%); }
            to { transform: translateX(0); }
        }
        
        .modal-ajuda.ativo {
            display: block;
        }
        
        .modal-ajuda-content {
            background: white;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            box-shadow: -5px 0 20px rgba(0, 0, 0, 0.3);
        }
        
        .modal-ajuda-header {
            background: linear-gradient(135deg, #dc3545, #c82333);
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-ajuda-header h2 {
            margin: 0;
            font-size: 20px;
        }
        
        .modal-ajuda-close {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            font-size: 24px;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            transition: 0.3s;
        }
        
        .modal-ajuda-close:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        
        .modal-ajuda-chat {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            background: #f5f5f5;
        }
        
        .modal-ajuda-input-section {
            padding: 20px;
            background: #fafafa;
            border-top: 1px solid #ddd;
        }
        
        .modal-ajuda-input-section #ajuda-input {
            flex: 1;
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 25px;
            font-size: 16px;
            outline: none;
            min-height: 50px;
        }
        
        .modal-ajuda-input-section #ajuda-input:focus {
            border-color: #dc3545;
        }
        
        .modal-ajuda-input-section #enviar-ajuda-btn {
            padding: 15px 30px;
            font-size: 16px;
            border-radius: 25px;
        }
        
        .modal-historico {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 10001;
            overflow-y: auto;
        }
        
        .modal-historico.ativo {
            display: flex;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.3s ease;
        }
        
        .modal-historico-content {
            background: white;
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 10px 50px rgba(0, 0, 0, 0.5);
            display: flex;
            flex-direction: column;
        }
        
        .modal-historico-header {
            background: linear-gradient(135deg, #1351B4, #0E4B99);
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-historico-header h2 {
            margin: 0;
            font-size: 20px;
        }
        
        .modal-historico-close {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            font-size: 24px;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            transition: 0.3s;
        }
        
        .modal-historico-close:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        
        .modal-historico-body {
            flex: 1;
            overflow-y: auto;
            padding: 30px;
        }
        
        .historico-item {
            margin-bottom: 20px;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #1351B4;
            background: #f8f9fa;
        }
        
        .historico-timestamp {
            font-size: 12px;
            color: #666;
            margin-bottom: 5px;
        }
        
        .historico-tipo {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: bold;
            margin-right: 10px;
        }
        
        .historico-tipo.usuario {
            background: #1351B4;
            color: white;
        }
        
        .historico-tipo.helena {
            background: #28a745;
            color: white;
        }
        
        .historico-mensagem {
            margin-top: 8px;
            line-height: 1.5;
            color: #333;
        }
        
        .modal-historico-footer {
            padding: 20px;
            background: #fafafa;
            border-top: 1px solid #eee;
            display: flex;
            gap: 10px;
            justify-content: center;
        }
        
        .btn-exportar-historico {
            padding: 12px 30px;
            border: none;
            border-radius: 25px;
            font-weight: bold;
            cursor: pointer;
            transition: 0.3s;
            background: #1351B4;
            color: white;
        }
        
        .btn-exportar-historico:hover {
            background: #0E4B99;
        }
        
        .validacao-servidor {
            position: absolute;
            right: 40px;
            top: 35px;
            font-size: 12px;
            padding: 4px 8px;
            border-radius: 4px;
            display: none;
        }
        
        .validacao-servidor.validando {
            display: block;
            background: #fff3cd;
            color: #856404;
        }
        
        .validacao-servidor.valido-servidor {
            display: block;
            background: #d4edda;
            color: #155724;
        }
        
        .validacao-servidor.invalido-servidor {
            display: block;
            background: #f8d7da;
            color: #721c24;
        }
        
        @media (max-width: 1200px) {
            .container {
                grid-template-columns: 1fr;
                gap: 20px;
            }
            
            .chat-section { 
                flex: 0.4; 
                min-width: 40%; 
                height: 100vh; 
            }
            
            .form-section { 
                flex: 0.6; 
                min-width: 60%; 
                height: 100vh; 
                height: auto;
                min-height: 500px;
            }
        }
        
        @media (max-width: 768px) {
            .areas-grid {
                grid-template-columns: 1fr;
            }
            
            .sistemas-grid {
                grid-template-columns: 1fr;
            }
            
            .form-content {
                padding: 20px;
            }
        }
        
        .fade-in {
            animation: fadeIn 0.5s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .pulse {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="chat-section">
            <div class="chat-header">
                <button class="reset-btn" onclick="reiniciarConversa()">üîÑ Reiniciar</button>
                <button class="historico-btn" onclick="abrirModalHistorico()">üìã Hist√≥rico</button>
                <h2>Helena - Assistente DECIPEX</h2>
                <p>Mapeamento conversacional de POPs</p>
                
                <div class="progress-container">
                    <div class="progress-bar" id="progress-bar"></div>
                </div>
                <div class="progress-text" id="progress-text">0/10 - Vamos come√ßar!</div>
            </div>
            
            <div id="chat-container"></div>
            
            <div class="input-section">
                <div class="input-group">
                    <input type="text" 
                           id="user-input" 
                           placeholder="Digite sua mensagem..."
                           maxlength="2000">
                    <button id="enviar-btn">Enviar</button>
                    <button id="ajuda-btn">üÜò Preciso de ajuda</button>
                </div>
            </div>
        </div>
        
        <div class="form-section">
            <div class="form-header">
                <div class="fields-indicator" id="fields-indicator">0/10 campos</div>
                <h2>Formul√°rio do POP</h2>
            </div>
            
            <div class="form-content">
                <form id="processo-form">
                    {% csrf_token %}
                    
                    <div class="form-section-header">
                        <h3>üìã Identifica√ß√£o do Processo</h3>
                    </div>
                    
                    <div class="form-group">
                        <label>√Årea DECIPEX</label>
                        <input type="text" id="area_nome" name="area_nome" readonly placeholder="Ser√° preenchido pela conversa">
                        <div class="validacao-feedback" id="valid-area"></div>
                        <div class="validacao-servidor"></div>
                    </div>
                    
                    <div class="form-group">
                        <label>C√≥digo na Arquitetura de Processos</label>
                        <input type="text" id="codigo_arquitetura" name="codigo_arquitetura" placeholder="Ex: 2.3.3.1">
                        <div class="validacao-feedback" id="valid-codigo"></div>
                        <div class="validacao-servidor"></div>
                    </div>
                    
                    <div class="form-group">
                        <label>Nome da Atividade</label>
                        <input type="text" id="nome_processo" name="nome_processo" placeholder="Ex: Conceder Ressarcimento a Aposentado Civil">
                        <div class="validacao-feedback" id="valid-nome"></div>
                        <div class="validacao-servidor"></div>
                    </div>
                    
                    <div class="form-group">
                        <label>Processo Espec√≠fico</label>
                        <input type="text" id="processo_especifico" name="processo_especifico" placeholder="Ex: Gest√£o de Benef√≠cios de Assist√™ncia √† Sa√∫de">
                        <div class="validacao-feedback" id="valid-processo"></div>
                        <div class="validacao-servidor"></div>
                    </div>
                    
                    <div class="form-section-header">
                        <h3>1. Entrega Esperada</h3>
                    </div>
                    
                    <div class="form-group">
                        <label>Entrega Esperada da Atividade</label>
                        <textarea id="entrega_esperada" name="entrega_esperada" placeholder="Descreva o resultado/produto final da atividade..."></textarea>
                        <div class="validacao-feedback" id="valid-entrega"></div>
                        <div class="validacao-servidor"></div>
                    </div>
                    
                    <div class="form-section-header">
                        <h3>2. Dispositivos Normativos</h3>
                    </div>
                    
                    <div class="form-group">
                        <label>Dispositivos Normativos Aplic√°veis</label>
                        <textarea id="dispositivos_normativos" name="dispositivos_normativos" placeholder="Ex: Art. 34 a 42 da IN SGP/SEDGG/ME n¬∫ 97/2022"></textarea>
                        <div class="validacao-feedback" id="valid-normativos"></div>
                        <div class="validacao-servidor"></div>
                    </div>
                    
                    <div class="form-section-header">
                        <h3>3. Sistemas Utilizados</h3>
                    </div>
                    
                    <div class="form-group">
                        <label>Sistemas Utilizados / Acessos Necess√°rios</label>
                        <input type="text" id="sistemas_utilizados" name="sistemas_utilizados" readonly placeholder="Ser√° preenchido pela conversa">
                        <div class="validacao-feedback" id="valid-sistemas"></div>
                        <div class="validacao-servidor"></div>
                    </div>
                    
                    <div class="form-section-header">
                        <h3>4. Operadores</h3>
                    </div>
                    
                    <div class="form-group">
                        <label>Operadores da Atividade</label>
                        <textarea id="operadores" name="operadores" placeholder="Ex: T√©cnico Especializado, Coordenador, Apoio-Gabinete..."></textarea>
                        <div class="validacao-feedback" id="valid-operadores"></div>
                        <div class="validacao-servidor"></div>
                    </div>
                    
                    <div class="form-section-header">
                        <h3>5. Tarefas/Etapas</h3>
                    </div>
                    
                    <div class="form-group">
                        <label>Etapas do Processo</label>
                        <div id="etapas-container">
                            <textarea id="etapas_display" name="etapas_display" readonly style="min-height: 150px;" placeholder="As etapas ser√£o listadas aqui conforme a conversa..."></textarea>
                        </div>
                        <div class="validacao-feedback" id="valid-etapas"></div>
                        <div class="validacao-servidor"></div>
                    </div>
                    
                    <div class="form-section-header">
                        <h3>6. Documentos</h3>
                    </div>
                    
                    <div class="form-group">
                        <label>Documentos, Formul√°rios e Modelos Utilizados</label>
                        <textarea id="documentos_utilizados" name="documentos_utilizados" placeholder="Liste os documentos necess√°rios e gerados..."></textarea>
                        <div class="validacao-feedback" id="valid-documentos"></div>
                        <div class="validacao-servidor"></div>
                    </div>
                    
                    <div class="form-section-header">
                        <h3>7. Pontos de Aten√ß√£o</h3>
                    </div>
                    
                    <div class="form-group">
                        <label>Pontos Gerais de Aten√ß√£o na Atividade</label>
                        <textarea id="pontos_atencao" name="pontos_atencao" placeholder="Alertas, cuidados especiais, observa√ß√µes importantes..."></textarea>
                        <div class="validacao-feedback" id="valid-pontos"></div>
                        <div class="validacao-servidor"></div>
                    </div>
                    
                    <div class="form-section-header">
                        <h3>8. Fluxos do Processo</h3>
                    </div>
                    
                    <div class="form-group">
                        <label>Entrada do Processo (De quais √°reas recebe insumos)</label>
                        <textarea id="fluxos_entrada" name="fluxos_entrada" readonly placeholder="√Åreas de entrada ser√£o preenchidas pela conversa..."></textarea>
                        <div class="validacao-feedback" id="valid-entrada"></div>
                        <div class="validacao-servidor"></div>
                    </div>
                    
                    <div class="form-group">
                        <label>Sa√≠da do Processo (Para quais √°reas entrega resultados)</label>
                        <textarea id="fluxos_saida" name="fluxos_saida" readonly placeholder="√Åreas de sa√≠da ser√£o preenchidas pela conversa..."></textarea>
                        <div class="validacao-feedback" id="valid-saida"></div>
                        <div class="validacao-servidor"></div>
                    </div>
                    
                </form>
            </div>
            
            <div class="form-actions">
                <button type="button" class="btn-form limpar" onclick="limparFormulario()">üóëÔ∏è Limpar</button>
                <button type="button" class="btn-form ver-preview" onclick="abrirModalPreview()" id="btn-ver-preview" disabled>üëÅÔ∏è Ver Preview</button>
                <button type="button" class="btn-form gerar-pdf" onclick="gerarPDF()" id="btn-gerar-pdf" disabled>üìÑ Gerar PDF</button>
            </div>
        </div>
    </div>
    
    <div class="modal-preview" id="modal-preview">
        <div class="modal-content-preview">
            <div class="modal-header-preview">
                <h2>Preview do POP - Visualiza√ß√£o antes de gerar PDF</h2>
                <button class="modal-close" onclick="fecharModalPreview()">√ó</button>
            </div>
            
            <div class="modal-body-preview" id="modal-body-preview"></div>
            
            <div class="modal-footer-preview">
                <button class="btn-modal voltar" onclick="fecharModalPreview()">‚Üê Voltar para editar</button>
                <button class="btn-modal confirmar" onclick="confirmarGerarPDF()">üìÑ Est√° perfeito! Gerar PDF</button>
            </div>
        </div>
    </div>
    
    <div class="modal-ajuda" id="modal-ajuda">
        <div class="modal-ajuda-content">
            <div class="modal-ajuda-header">
                <h2>üÜò Central de Ajuda - Helena</h2>
                <button class="modal-ajuda-close" onclick="fecharModalAjuda()">√ó</button>
            </div>
            
            <div class="modal-ajuda-chat" id="modal-ajuda-chat"></div>
            
            <div class="modal-ajuda-input-section">
                <div class="input-group">
                    <input type="text" 
                           id="ajuda-input" 
                           placeholder="Descreva sua d√∫vida..."
                           maxlength="2000">
                    <button id="enviar-ajuda-btn" style="background: #dc3545;">Enviar</button>
                </div>
            </div>
        </div>
    </div>
    
    <div class="modal-historico" id="modal-historico">
        <div class="modal-historico-content">
            <div class="modal-historico-header">
                <h2>üìã Hist√≥rico Completo da Conversa</h2>
                <button class="modal-historico-close" onclick="fecharModalHistorico()">√ó</button>
            </div>
            
            <div class="modal-historico-body" id="modal-historico-body"></div>
            
            <div class="modal-historico-footer">
                <button class="btn-exportar-historico" onclick="exportarHistorico()">üì• Exportar Hist√≥rico (JSON)</button>
                <button class="btn-modal voltar" onclick="fecharModalHistorico()">Fechar</button>
            </div>
        </div>
    </div>
    
    <script>
        const chatContainer = document.getElementById('chat-container');
        const userInput = document.getElementById('user-input');
        const enviarBtn = document.getElementById('enviar-btn');
        const progressBar = document.getElementById('progress-bar');
        const progressText = document.getElementById('progress-text');
        const fieldsIndicator = document.getElementById('fields-indicator');
        
        let processando = false;
        let dadosColetas = {};
        let sessionId = 'user_' + Date.now();
        let historicoCompleto = [];
        
        let ajudaSessionId = 'ajuda_' + Date.now();
        let processandoAjuda = false;
        
        inicializarChat();
        
        function inicializarChat() {
            adicionarMensagem('helena', 'Ol√°! Sou a Helena, assistente da DECIPEX para mapeamento de processos. Como voc√™ gostaria de ser chamado?');
            atualizarProgresso(0, '0/10 - Vamos come√ßar!');
        }
        
        enviarBtn.addEventListener('click', enviarMensagem);
        userInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !processando) enviarMensagem();
        });
        
        document.querySelectorAll('input, textarea').forEach(campo => {
            campo.addEventListener('input', () => validarCampo(campo));
            
            campo.addEventListener('blur', async function() {
                const valor = this.value.trim();
                if (valor.length > 5 && !this.hasAttribute('readonly')) {
                    await validarCampoServidor(this, valor);
                }
            });
        });
        
        const ajudaBtn = document.getElementById('ajuda-btn');
        const modalAjuda = document.getElementById('modal-ajuda');
        const ajudaChatContainer = document.getElementById('modal-ajuda-chat');
        const ajudaInput = document.getElementById('ajuda-input');
        const enviarAjudaBtn = document.getElementById('enviar-ajuda-btn');
        
        ajudaBtn.addEventListener('click', abrirModalAjuda);
        enviarAjudaBtn.addEventListener('click', enviarMensagemAjuda);
        ajudaInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !processandoAjuda) enviarMensagemAjuda();
        });
        
        async function enviarMensagem() {
            const mensagem = userInput.value.trim();
            if (!mensagem || processando) return;
            
            processando = true;
            enviarBtn.disabled = true;
            enviarBtn.textContent = 'Enviando...';
            
            adicionarMensagem('usuario', mensagem);
            userInput.value = '';
            
            historicoCompleto.push({
                timestamp: new Date().toISOString(),
                tipo: 'usuario',
                mensagem: mensagem
            });
            
            const loadingId = adicionarMensagem('helena', 'Processando...', 'loading');
            
            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 10000);
                
                const response = await fetch('/api/chat/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                    body: JSON.stringify({
                        message: mensagem,
                        contexto: 'gerador_pop',
                        session_id: sessionId
                    }),
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                
                document.getElementById(loadingId)?.remove();
                
                processarResposta(data);
                
            } catch (error) {
                console.error('Erro:', error);
                document.getElementById(loadingId)?.remove();
                
                if (error.name === 'AbortError') {
                    adicionarMensagem('helena', '‚è∞ Timeout - A resposta demorou muito. Tente uma pergunta mais simples.');
                } else {
                    adicionarMensagem('helena', '‚ùå Erro de conex√£o. Verifique sua internet e tente novamente.');
                }
            } finally {
                processando = false;
                enviarBtn.disabled = false;
                enviarBtn.textContent = 'Enviar';
                userInput.focus();
            }
        }
        
        function processarResposta(data) {
            adicionarMensagem('helena', data.resposta || 'N√£o entendi. Pode reformular?');
            
            historicoCompleto.push({
                timestamp: new Date().toISOString(),
                tipo: 'helena',
                mensagem: data.resposta || 'N√£o entendi. Pode reformular?',
                dados_interface: data.tipo_interface || null,
                dados_extraidos: data.dados_extraidos || null
            });
            
            if (data.tipo_interface) {
                criarInterface(data.tipo_interface, data.dados_interface || {});
            }

            if (data.dados_extraidos) {
                dadosColetas = {...dadosColetas, ...data.dados_extraidos};
                preencherFormulario(dadosColetas);
            }
            
            if (data.progresso) {
                const [atual, total] = data.progresso.split('/');
                const porcentagem = (parseInt(atual) / parseInt(total)) * 100;
                atualizarProgresso(porcentagem, data.progresso);
            }
            
            if (data.conversa_completa) {
                ativarModoRevisao();
            }
        }
        
        function criarInterface(tipo, dados) {
            const ultimaInterface = document.querySelector('.interface-container:last-of-type');
            if (ultimaInterface && ultimaInterface.querySelector('.action-buttons')) {
                ultimaInterface.remove();
            }
            
            const container = document.createElement('div');
            container.className = 'interface-container fade-in';
            
            if (tipo === 'areas') {
                criarInterfaceAreas(container, dados);
            } else if (tipo === 'sistemas') {
                criarInterfaceSistemas(container, dados);
            } else if (tipo === 'normas') {
                criarInterfaceNormas(container, dados);
            } else if (tipo === 'operadores') {
                criarInterfaceOperadores(container, dados);
            } else if (tipo === 'dropdown_macro' || tipo === 'dropdown_processo' || 
                       tipo === 'dropdown_subprocesso' || tipo === 'dropdown_atividade') {
                criarInterfaceDropdownArquitetura(container, dados, tipo);
            } else if (tipo === 'fluxos_entrada' || tipo === 'fluxos_saida') {
                criarInterfaceFluxos(container, dados);
            } else if (tipo === 'revisao') {
                criarInterfaceRevisao(container, dados);
            } else if (tipo === 'operadores_etapa') {
                criarInterfaceOperadoresEtapa(container, dados);
            }
            
            chatContainer.appendChild(container);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }
        
        function criarInterfaceAreas(container, dados) {
            container.innerHTML = `
                <div class="interface-title">üè¢ Selecione sua √°rea na DECIPEX:</div>
                <div class="areas-grid" id="areas-grid"></div>
                <div class="action-buttons">
                    <button class="btn-interface btn-primary" onclick="confirmarArea()">Confirmar √Årea</button>
                </div>
            `;
            
            const grid = container.querySelector('#areas-grid');
            
            Object.entries(dados.opcoes_areas || {}).forEach(([id, area]) => {
                const div = document.createElement('div');
                div.className = 'area-option';
                div.dataset.areaId = id;
                div.innerHTML = `
                    <div class="area-codigo">${area.codigo}</div>
                    <div class="area-nome">${area.nome}</div>
                `;
                
                div.addEventListener('click', () => {
                    document.querySelectorAll('.area-option').forEach(el => el.classList.remove('selected'));
                    div.classList.add('selected');
                });
                
                grid.appendChild(div);
            });
        }
        
        function criarInterfaceSistemas(container, dados) {
            container.innerHTML = `
                <div class="interface-title">üíª Quais sistemas voc√™ utiliza neste processo?</div>
                <div class="sistemas-container" id="sistemas-container"></div>
                
                <div class="form-group" style="margin-top: 15px;">
                    <label>Outros sistemas n√£o listados:</label>
                    <textarea id="outros-sistemas" placeholder="Digite outros sistemas n√£o listados, separados por v√≠rgula..." style="width:100%; padding:10px; min-height:60px; border-radius:8px; border:2px solid #ddd;"></textarea>
                </div>
                
                <div class="action-buttons">
                    <button class="btn-interface btn-secondary" onclick="pularSistemas()">N√£o sei / Pular</button>
                    <button class="btn-interface btn-primary" onclick="confirmarSistemas()">Confirmar Sistemas</button>
                </div>
            `;
            
            const container_sistemas = container.querySelector('#sistemas-container');
            
            Object.entries(dados.sistemas_por_categoria || {}).forEach(([categoria, sistemas]) => {
                const categoriaDiv = document.createElement('div');
                categoriaDiv.className = 'categoria-sistemas';
                
                const tituloCategoria = {
                    'gestao_pessoal': 'üë• Gest√£o de Pessoal',
                    'documentos': 'üìÑ Documentos e Processos',
                    'transparencia': 'üîç Transpar√™ncia e Consultas',
                    'previdencia': 'üí∞ Previd√™ncia',
                    'comunicacao': 'üí¨ Comunica√ß√£o',
                    'outros': '‚öôÔ∏è Outros'
                };
                
                categoriaDiv.innerHTML = `
                    <div class="categoria-titulo">${tituloCategoria[categoria] || categoria}</div>
                    <div class="sistemas-grid" id="sistemas-${categoria}"></div>
                `;
                
                const grid = categoriaDiv.querySelector(`#sistemas-${categoria}`);
                
                sistemas.forEach(sistema => {
                    const div = document.createElement('div');
                    div.className = 'sistema-checkbox';
                    div.innerHTML = `
                        <input type="checkbox" id="sistema-${sistema}" value="${sistema}">
                        <label for="sistema-${sistema}">${sistema}</label>
                    `;
                    
                    div.addEventListener('click', (e) => {
                        if (e.target.tagName !== 'INPUT') {
                            const checkbox = div.querySelector('input[type="checkbox"]');
                            checkbox.checked = !checkbox.checked;
                            checkbox.dispatchEvent(new Event('change'));
                        }
                    });

                    div.querySelector('input[type="checkbox"]').addEventListener('change', function() {
                        div.classList.toggle('selected', this.checked);
                    });
                    
                    grid.appendChild(div);
                });
                
                container_sistemas.appendChild(categoriaDiv);
            });
        }
        
        function criarInterfaceNormas(container, dados) {
            container.innerHTML = `
                <div class="interface-title">üìã Selecione as normas aplic√°veis:</div>
                <div style="background: #fff3cd; padding: 10px; border-radius: 8px; margin-bottom: 15px; font-size: 13px;">
                    <strong>ü§ñ Sugest√µes da IA:</strong> Normas destacadas foram sugeridas automaticamente com base no contexto do seu processo
                </div>
                <div id="normas-container" style="max-height: 300px; overflow-y: auto; margin: 15px 0;"></div>
                <div class="form-group" style="margin-top: 15px;">
                    <label>Outras normas n√£o listadas:</label>
                    <textarea id="outras-normas" placeholder="Digite outras normas que n√£o est√£o na lista..." style="width:100%; padding:10px; min-height:60px; border-radius:8px; border:2px solid #ddd;"></textarea>
                </div>
                <div class="action-buttons">
                    <button class="btn-interface btn-primary" onclick="confirmarNormas()">Confirmar Normas</button>
                </div>
            `;
            
            const normasContainer = container.querySelector('#normas-container');
            
            if (dados.sugestoes && Array.isArray(dados.sugestoes)) {
                dados.sugestoes.forEach((norma, idx) => {
                    const div = document.createElement('div');
                    div.className = 'sistema-checkbox norma-sugerida';
                    div.innerHTML = `
                        <input type="checkbox" id="norma-${idx}" value="${norma.nome_completo || norma}">
                        <label for="norma-${idx}">${norma.nome_curto || norma} ${norma.nome_completo ? '- ' + norma.nome_completo : ''}</label>
                    `;
                    
                    div.addEventListener('click', (e) => {
                        if (e.target.tagName !== 'INPUT') {
                            const checkbox = div.querySelector('input');
                            checkbox.checked = !checkbox.checked;
                            checkbox.dispatchEvent(new Event('change'));
                        }
                    });

                    div.querySelector('input[type="checkbox"]').addEventListener('change', function() {
                        div.classList.toggle('selected', this.checked);
                    });
                    
                    normasContainer.appendChild(div);
                });
            }
        }
        
        function criarInterfaceOperadores(container, dados) {
            container.innerHTML = `
                <div class="interface-title">üë• Quem executa esta atividade? (Selecione todos que se aplicam)</div>
                <div class="sistemas-container" id="operadores-container"></div>
                <div class="form-group" style="margin-top: 15px;">
                    <label>Outros operadores n√£o listados:</label>
                    <textarea id="outros-operadores" placeholder="Digite outros operadores n√£o listados, separados por v√≠rgula..." style="width:100%; padding:10px; min-height:60px; border-radius:8px; border:2px solid #ddd;"></textarea>
                </div>
                <div class="action-buttons">
                    <button class="btn-interface btn-primary" onclick="confirmarOperadores()">Confirmar</button>
                </div>
            `;
            
            const container_operadores = container.querySelector('#operadores-container');
            
            (dados.opcoes || []).forEach(operador => {
                const div = document.createElement('div');
                div.className = 'sistema-checkbox';
                div.innerHTML = `
                    <input type="checkbox" id="operador-${operador.replace(/\s+/g, '-')}" value="${operador}">
                    <label for="operador-${operador.replace(/\s+/g, '-')}">${operador}</label>
                `;

                const checkbox = div.querySelector('input[type="checkbox"]');

                div.addEventListener('click', (e) => {
                    if (e.target !== checkbox) {
                        checkbox.checked = !checkbox.checked;
                        checkbox.dispatchEvent(new Event('change'));
                    }
                });

                checkbox.addEventListener('change', function() {
                    div.classList.toggle('selected', this.checked);
                });

                container_operadores.appendChild(div);
            });
        }
        
        function criarInterfaceDropdownArquitetura(container, dados, tipo) {
            const titulos = {
                'dropdown_macro': 'üèõÔ∏è Selecione o Macroprocesso',
                'dropdown_processo': 'üìã Selecione o Processo',
                'dropdown_subprocesso': 'üîπ Selecione o Subprocesso',
                'dropdown_atividade': '‚úÖ Selecione a Atividade'
            };
            
            container.innerHTML = `
                <div class="interface-title">${titulos[tipo]}</div>
                <select id="select-arquitetura" style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 14px;">
                    <option value="">-- Selecione --</option>
                </select>
                
                <div id="campo-customizado" style="display: none; margin-top: 15px;">
                    <label>Digite o nome:</label>
                    <input type="text" id="input-customizado" placeholder="Digite aqui..." style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; margin-top: 5px;">
                </div>
                
                <div class="action-buttons">
                    <button class="btn-interface btn-primary" onclick="confirmarArquitetura()">Confirmar</button>
                </div>
            `;
            
            const select = container.querySelector('#select-arquitetura');
            
            (dados.opcoes || []).forEach(opcao => {
                const option = document.createElement('option');
                option.value = opcao;
                option.textContent = opcao;
                select.appendChild(option);
            });
            
            const optionOutro = document.createElement('option');
            optionOutro.value = '__OUTRO__';
            optionOutro.textContent = '‚ûï Nenhuma destas op√ß√µes (digitar)';
            select.appendChild(optionOutro);
            
            select.addEventListener('change', function() {
                const campoCustomizado = document.getElementById('campo-customizado');
                const inputCustomizado = document.getElementById('input-customizado');
                
                if (this.value === '__OUTRO__') {
                    campoCustomizado.style.display = 'block';
                    inputCustomizado.focus();
                } else {
                    campoCustomizado.style.display = 'none';
                    inputCustomizado.value = '';
                }
            });
        }
        
        function criarInterfaceFluxos(container, dados) {
            const tipoFluxo = dados.tipo_fluxo === 'entrada' ? 'recebe insumos de' : 'entrega resultados para';
            
            container.innerHTML = `
                <div class="interface-title">üîÑ Seu processo ${tipoFluxo} outras √°reas?</div>
                <div class="areas-grid" id="fluxos-areas"></div>
                
                <div style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                    <div style="font-weight: bold; margin-bottom: 10px;">Op√ß√µes Adicionais:</div>
                    
                    <div style="margin: 10px 0;">
                        <input type="checkbox" id="checkbox-area-interna" style="margin-right: 8px;">
                        <label for="checkbox-area-interna">Outra √°rea interna da minha coordena√ß√£o geral</label>
                        <input type="text" id="input-area-interna" placeholder="Especifique a √°rea interna..." style="display: none; width: 100%; margin-top: 5px; padding: 8px; border: 2px solid #ddd; border-radius: 6px;">
                    </div>
                    
                    <div style="margin: 10px 0;">
                        <input type="checkbox" id="checkbox-area-externa" style="margin-right: 8px;">
                        <label for="checkbox-area-externa">√Årea externa da DECIPEX</label>
                        <input type="text" id="input-area-externa" placeholder="Especifique a √°rea externa..." style="display: none; width: 100%; margin-top: 5px; padding: 8px; border: 2px solid #ddd; border-radius: 6px;">
                    </div>
                    
                    <div style="margin: 10px 0;">
                        <input type="checkbox" id="checkbox-outra-decipex" style="margin-right: 8px;">
                        <label for="checkbox-outra-decipex">Outra √°rea da DECIPEX n√£o listada</label>
                        <input type="text" id="input-outra-decipex" placeholder="Especifique a √°rea..." style="display: none; width: 100%; margin-top: 5px; padding: 8px; border: 2px solid #ddd; border-radius: 6px;">
                    </div>
                </div>
                
                <div class="action-buttons">
                    <button class="btn-interface btn-secondary" onclick="confirmarFluxo('n√£o')">N√£o</button>
                    <button class="btn-interface btn-primary" onclick="confirmarFluxo('sim')">Sim - Confirmar</button>
                </div>
            `;
            
            const grid = container.querySelector('#fluxos-areas');
            
            Object.entries(dados.opcoes_areas || {}).forEach(([id, area]) => {
                const div = document.createElement('div');
                div.className = 'area-option';
                div.dataset.areaId = id;
                div.innerHTML = `
                    <div class="area-codigo">${area.codigo}</div>
                    <div class="area-nome">${area.nome}</div>
                `;
                
                div.addEventListener('click', () => {
                    div.classList.toggle('selected');
                });
                
                grid.appendChild(div);
            });
            
            ['interna', 'externa', 'outra-decipex'].forEach(tipo => {
                const checkbox = container.querySelector(`#checkbox-area-${tipo}`);
                const input = container.querySelector(`#input-area-${tipo}`);
                
                if (checkbox && input) {
                    checkbox.addEventListener('change', function() {
                        input.style.display = this.checked ? 'block' : 'none';
                        if (!this.checked) input.value = '';
                    });
                }
            });
        }
        
        function criarInterfaceRevisao(container, dados) {
            container.innerHTML = `
                <div class="interface-title">‚úÖ Revis√£o Final - Dados Coletados</div>
                <div style="background: white; padding: 15px; border-radius: 8px; margin: 10px 0;">
                    <pre style="white-space: pre-wrap; font-family: inherit; margin: 0;">${JSON.stringify(dados.dados_completos, null, 2)}</pre>
                </div>
                <div class="action-buttons">
                    <button class="btn-interface btn-secondary" onclick="editarDados()">‚úèÔ∏è Editar</button>
                    <button class="btn-interface btn-primary" onclick="finalizarPOP()">üéØ Finalizar POP</button>
                </div>
            `;
        }
        
        function criarInterfaceOperadoresEtapa(container, dados) {
            const numeroEtapa = dados.numero_etapa || '?';
            const descricaoEtapa = dados.descricao_etapa || 'esta etapa';
            
            container.innerHTML = `
                <div class="interface-title">üë• Quem executa a Etapa ${numeroEtapa}?</div>
                <div class="operadores-etapa-container">
                    <div class="operadores-etapa-titulo">
                        Etapa: ${descricaoEtapa}
                    </div>
                    <div class="operadores-etapa-grid" id="operadores-etapa-grid"></div>
                    <div class="form-group" style="margin-top: 15px;">
                        <label>Outros operadores para esta etapa:</label>
                        <textarea id="outros-operadores-etapa" placeholder="Digite outros operadores n√£o listados, separados por v√≠rgula..." style="width:100%; padding:10px; min-height:60px; border-radius:8px; border:2px solid #ddd;"></textarea>
                    </div>
                </div>
                <div class="action-buttons">
                    <button class="btn-interface btn-secondary" onclick="pularOperadoresEtapa()">Pular (usar operadores gerais)</button>
                    <button class="btn-interface btn-primary" onclick="confirmarOperadoresEtapa()">Confirmar Operadores</button>
                </div>
            `;
            
            const grid = container.querySelector('#operadores-etapa-grid');
            
            (dados.opcoes_operadores || []).forEach(operador => {
                const div = document.createElement('div');
                div.className = 'sistema-checkbox';
                div.innerHTML = `
                    <input type="checkbox" id="op-etapa-${operador.replace(/\s+/g, '-')}" value="${operador}">
                    <label for="op-etapa-${operador.replace(/\s+/g, '-')}">${operador}</label>
                `;
                
                const checkbox = div.querySelector('input[type="checkbox"]');
                
                div.addEventListener('click', (e) => {
                    if (e.target !== checkbox) {
                        checkbox.checked = !checkbox.checked;
                        checkbox.dispatchEvent(new Event('change'));
                    }
                });
                
                checkbox.addEventListener('change', function() {
                    div.classList.toggle('selected', this.checked);
                });
                
                grid.appendChild(div);
            });
        }
        
        function confirmarArea() {
            const areaSelecionada = document.querySelector('.area-option.selected');
            if (!areaSelecionada) {
                alert('Por favor, selecione uma √°rea.');
                return;
            }
            
            const areaId = areaSelecionada.dataset.areaId;
            userInput.value = areaId;
            enviarMensagem();
        }
        
        function confirmarSistemas() {
            const sistemasSelecionados = [];
            document.querySelectorAll('.sistema-checkbox input[type="checkbox"]:checked').forEach(checkbox => {
                sistemasSelecionados.push(checkbox.value);
            });
            
            const outrosSistemas = document.getElementById('outros-sistemas');
            if (outrosSistemas && outrosSistemas.value.trim()) {
                const sistemasAdicionais = outrosSistemas.value.split(',').map(s => s.trim()).filter(s => s);
                sistemasSelecionados.push(...sistemasAdicionais);
            }
            
            const resposta = sistemasSelecionados.length > 0 
                ? sistemasSelecionados.join(', ')
                : 'Nenhum sistema espec√≠fico';
                
            enviarResposta(resposta);
        }
        
        function pularSistemas() {
            enviarResposta('n√£o sei');
        }
        
        function confirmarNormas() {
            const normasSelecionadas = [];
            
            document.querySelectorAll('#normas-container input[type="checkbox"]:checked').forEach(cb => {
                normasSelecionadas.push(cb.value);
            });
            
            const outrasNormas = document.getElementById('outras-normas').value.trim();
            if (outrasNormas) {
                normasSelecionadas.push(outrasNormas);
            }
            
            const resposta = normasSelecionadas.length > 0
                ? normasSelecionadas.join('; ')
                : 'Nenhuma norma espec√≠fica';
            
            enviarResposta(resposta);
        }
        
        function confirmarOperadores() {
            const operadoresSelecionados = [];
            
            document.querySelectorAll('#operadores-container input[type="checkbox"]:checked').forEach(checkbox => {
                operadoresSelecionados.push(checkbox.value);
            });
            
            const outrosOperadores = document.getElementById('outros-operadores');
            if (outrosOperadores && outrosOperadores.value.trim()) {
                const operadoresAdicionais = outrosOperadores.value.split(',').map(s => s.trim()).filter(s => s);
                operadoresSelecionados.push(...operadoresAdicionais);
            }
            
            if (operadoresSelecionados.length === 0) {
                alert('Por favor, selecione pelo menos um operador.');
                return;
            }
            
            const resposta = operadoresSelecionados.join(', ');
            enviarResposta(resposta);
        }

        function confirmarArquitetura() {
            const select = document.getElementById('select-arquitetura');
            const inputCustomizado = document.getElementById('input-customizado');
            
            let valor;
            
            if (select.value === '__OUTRO__') {
                valor = inputCustomizado.value.trim();
                
                if (!valor) {
                    alert('Por favor, digite o nome no campo de texto.');
                    inputCustomizado.focus();
                    return;
                }
            } else {
                valor = select.value;
                
                if (!valor || valor === '') {
                    alert('Por favor, selecione uma op√ß√£o do dropdown.');
                    return;
                }
            }
            
            const interface = document.querySelector('.interface-container:last-child');
            if (interface) {
                interface.remove();
            }
            
            enviarResposta(valor);
        }
        
        function confirmarFluxo(resposta) {
            if (resposta === 'sim') {
                const areasSelecionadas = [];
                
                document.querySelectorAll('.area-option.selected').forEach(area => {
                    areasSelecionadas.push(area.querySelector('.area-codigo').textContent);
                });
                
                const checkInterna = document.getElementById('checkbox-area-interna');
                const inputInterna = document.getElementById('input-area-interna');
                if (checkInterna && checkInterna.checked && inputInterna && inputInterna.value.trim()) {
                    areasSelecionadas.push(`INTERNA: ${inputInterna.value.trim()}`);
                }
                
                const checkExterna = document.getElementById('checkbox-area-externa');
                const inputExterna = document.getElementById('input-area-externa');
                if (checkExterna && checkExterna.checked && inputExterna && inputExterna.value.trim()) {
                    areasSelecionadas.push(`EXTERNA: ${inputExterna.value.trim()}`);
                }
                
                const checkOutra = document.getElementById('checkbox-outra-decipex');
                const inputOutra = document.getElementById('input-outra-decipex');
                if (checkOutra && checkOutra.checked && inputOutra && inputOutra.value.trim()) {
                    areasSelecionadas.push(`OUTRA: ${inputOutra.value.trim()}`);
                }
                
                enviarResposta(areasSelecionadas.length > 0 ? 'sim' : 'n√£o');
            } else {
                enviarResposta('n√£o');
            }
        }
        
        function editarDados() {
            enviarResposta('quero editar alguns dados');
        }
        
        function finalizarPOP() {
            enviarResposta('finalizar');
        }
        
        function confirmarOperadoresEtapa() {
            const operadoresSelecionados = [];
            
            document.querySelectorAll('#operadores-etapa-grid input[type="checkbox"]:checked').forEach(checkbox => {
                operadoresSelecionados.push(checkbox.value);
            });
            
            const outrosOperadores = document.getElementById('outros-operadores-etapa');
            if (outrosOperadores && outrosOperadores.value.trim()) {
                const operadoresAdicionais = outrosOperadores.value.split(',').map(s => s.trim()).filter(s => s);
                operadoresSelecionados.push(...operadoresAdicionais);
            }
            
            if (operadoresSelecionados.length === 0) {
                alert('Por favor, selecione pelo menos um operador para esta etapa.');
                return;
            }
            
            const resposta = operadoresSelecionados.join(', ');
            enviarResposta(resposta);
        }
        
        function pularOperadoresEtapa() {
            enviarResposta('usar operadores gerais');
        }
        
        async function enviarResposta(resposta) {
            userInput.value = resposta;
            await enviarMensagem();
        }
        
        function adicionarMensagem(tipo, texto, classe = '') {
            const div = document.createElement('div');
            const id = 'msg-' + Date.now() + Math.random();
            div.id = id;
            div.className = `mensagem ${tipo} ${classe}`;
            div.textContent = texto;
            chatContainer.appendChild(div);
            chatContainer.scrollTop = chatContainer.scrollHeight;
            return id;
        }
        
        function preencherFormulario(dados) {
            Object.entries(dados).forEach(([campo, valor]) => {
                let input = document.getElementById(campo);
                
                if (campo === 'codigo_processo') {
                    input = document.getElementById('codigo_arquitetura');
                } else if (campo === 'area' && valor.nome) {
                    input = document.getElementById('area_nome');
                    valor = `${valor.codigo} - ${valor.nome}`;
                } else if (campo === 'sistemas' && Array.isArray(valor)) {
                    input = document.getElementById('sistemas_utilizados');
                    valor = valor.join(', ');
                } else if (campo === 'fluxos_entrada' && Array.isArray(valor)) {
                    input = document.getElementById('fluxos_entrada');
                    valor = valor.length > 0 ? valor.join(', ') : 'Nenhuma √°rea de entrada';
                } else if (campo === 'fluxos_saida' && Array.isArray(valor)) {
                    input = document.getElementById('fluxos_saida');
                    valor = valor.length > 0 ? valor.join(', ') : 'Nenhuma √°rea de sa√≠da';
                } else if (campo === 'etapas' && Array.isArray(valor)) {
                    const etapasContainer = document.getElementById('etapas-container');
                    if (etapasContainer) {
                        etapasContainer.innerHTML = '';
                        
                        valor.forEach((etapa, i) => {
                            const etapaBox = document.createElement('div');
                            etapaBox.style.cssText = 'border: 2px solid #1351B4; padding: 12px; margin: 8px 0; border-radius: 8px; background: #f0f4ff;';
                            
                            let conteudoHTML = `
                                <div style="font-weight: bold; color: #1351B4; margin-bottom: 5px;">
                                    üìå Etapa ${i + 1}
                                </div>
                                <div style="font-size: 14px; line-height: 1.4;">
                                    ${etapa.descricao || etapa}
                                </div>
                            `;
                            
                            if (etapa.detalhes && Array.isArray(etapa.detalhes) && etapa.detalhes.length > 0) {
                                conteudoHTML += '<div style="margin-top: 10px; padding-left: 20px; border-left: 2px solid #1351B4;">';
                                etapa.detalhes.forEach((detalhe, j) => {
                                    conteudoHTML += `
                                        <div style="font-size: 13px; color: #666; margin: 5px 0;">
                                            ${i + 1}.${j + 1} ${detalhe}
                                        </div>
                                    `;
                                });
                                conteudoHTML += '</div>';
                            }
                            
                            etapaBox.innerHTML = conteudoHTML;
                            etapasContainer.appendChild(etapaBox);
                        });
                        
                        return;
                    }
                }
                
                if (input && valor) {
                    input.value = valor;
                    input.classList.add('preenchido');
                    validarCampo(input);
                }
            });
            
            atualizarIndicadorCampos();
        }
        
        function validarCampo(campo) {
            const valor = campo.value.trim();
            const validIcon = document.getElementById(`valid-${campo.id.replace('_display', '').replace('_nome', '')}`);
            
            if (validIcon) {
                if (valor.length > 5) {
                    validIcon.textContent = '‚úì';
                    validIcon.className = 'validacao-feedback valido';
                } else if (valor.length > 0) {
                    validIcon.textContent = '‚ö†';
                    validIcon.className = 'validacao-feedback invalido';
                } else {
                    validIcon.textContent = '';
                    validIcon.className = 'validacao-feedback';
                }
            }
            
            atualizarIndicadorCampos();
        }
        
        function atualizarIndicadorCampos() {
            const campos = document.querySelectorAll('#processo-form input, #processo-form textarea');
            const preenchidos = Array.from(campos).filter(campo => campo.value.trim().length > 5);
            
            fieldsIndicator.textContent = `${preenchidos.length}/${campos.length} campos`;
            
            const porcentagem = (preenchidos.length / campos.length) * 100;
            if (porcentagem >= 80) {
                fieldsIndicator.style.background = 'rgba(76, 175, 80, 0.3)';
            } else if (porcentagem >= 50) {
                fieldsIndicator.style.background = 'rgba(255, 152, 0, 0.3)';
            } else {
                fieldsIndicator.style.background = 'rgba(244, 67, 54, 0.3)';
            }
        }
        
        function atualizarProgresso(porcentagem, texto) {
            progressBar.style.width = `${porcentagem}%`;
            progressText.textContent = texto;
            
            if (porcentagem >= 100) {
                progressBar.classList.add('pulse');
            }
        }
        
        function ativarModoRevisao() {
            const formSection = document.querySelector('.form-section');
            const btnGerarPDF = document.getElementById('btn-gerar-pdf');
            const btnVerPreview = document.getElementById('btn-ver-preview');
            const formHeader = document.querySelector('.form-header h2');
            
            formSection.classList.add('modo-revisao');
            formHeader.textContent = 'Revis√£o Final - Ajuste se necess√°rio';
            
            btnGerarPDF.disabled = false;
            btnGerarPDF.classList.add('btn-gerar-pdf-ativo', 'pulse');
            
            btnVerPreview.disabled = false;
            
            document.querySelectorAll('#processo-form input, #processo-form textarea').forEach(campo => {
                if (campo.hasAttribute('readonly')) {
                    campo.removeAttribute('readonly');
                }
                
                campo.addEventListener('input', function() {
                    this.style.borderColor = '#28a745';
                    this.style.background = '#f8fff9';
                    
                    const validacao = document.getElementById(`valid-${this.id.replace('_display', '').replace('_nome', '')}`);
                    if (validacao) {
                        validacao.textContent = '‚úì';
                        validacao.style.color = '#28a745';
                    }
                });
            });
            
            adicionarMensagem('helena', '‚úì POP finalizado! Voc√™ pode revisar os campos, ver o preview ou gerar o PDF final.');
        }
        
        function abrirModalPreview() {
            const modal = document.getElementById('modal-preview');
            const modalBody = document.getElementById('modal-body-preview');
            
            const previewHTML = gerarHTMLPreview();
            modalBody.innerHTML = previewHTML;
            
            modal.classList.add('ativo');
            document.body.style.overflow = 'hidden';
        }
        
        function fecharModalPreview() {
            const modal = document.getElementById('modal-preview');
            modal.classList.remove('ativo');
            document.body.style.overflow = 'auto';
        }
        
        function gerarHTMLPreview() {
            const dados = dadosColetas;
            
            let html = `
                <div class="preview-identificacao">
                    <h1>PROCEDIMENTO OPERACIONAL PADR√ÉO</h1>
                    <p><strong>C√≥digo:</strong> ${dados.codigo_processo || 'X.X.X.X'}</p>
                    <p><strong>Atividade:</strong> ${dados.nome_processo || 'N√£o informado'}</p>
                    <p><strong>√Årea:</strong> ${dados.area?.nome || 'N√£o informado'}</p>
                </div>
            `;
            
            html += `
                <div class="preview-secao">
                    <div class="preview-titulo">1. ENTREGA ESPERADA DA ATIVIDADE</div>
                    <div class="preview-conteudo">${dados.entrega_esperada || 'N√£o informado'}</div>
                </div>
            `;
            
            html += `
                <div class="preview-secao">
                    <div class="preview-titulo">2. DISPOSITIVOS NORMATIVOS APLIC√ÅVEIS</div>
                    <div class="preview-conteudo">${dados.dispositivos_normativos || 'N√£o informado'}</div>
                </div>
            `;
            
            const sistemas = Array.isArray(dados.sistemas) ? dados.sistemas.join(', ') : dados.sistemas || 'N√£o informado';
            html += `
                <div class="preview-secao">
                    <div class="preview-titulo">3. SISTEMAS UTILIZADOS / ACESSOS NECESS√ÅRIOS</div>
                    <div class="preview-conteudo">${sistemas}</div>
                </div>
            `;
            
            html += `
                <div class="preview-secao">
                    <div class="preview-titulo">4. OPERADORES DA ATIVIDADE</div>
                    <div class="preview-conteudo">${dados.operadores || 'N√£o informado'}</div>
                </div>
            `;
            
            let etapasHTML = '';
            if (dados.etapas && Array.isArray(dados.etapas) && dados.etapas.length > 0) {
                dados.etapas.forEach((etapa, i) => {
                    etapasHTML += `<p><strong>${i + 1}.</strong> ${etapa.descricao || etapa}</p>`;
                });
            } else {
                etapasHTML = 'Nenhuma etapa mapeada';
            }
            
            html += `
                <div class="preview-secao">
                    <div class="preview-titulo">5. TAREFAS REALIZADAS NA ATIVIDADE</div>
                    <div class="preview-conteudo">${etapasHTML}</div>
                </div>
            `;
            
            html += `
                <div class="preview-secao">
                    <div class="preview-titulo">6. DOCUMENTOS, FORMUL√ÅRIOS E MODELOS UTILIZADOS</div>
                    <div class="preview-conteudo">${dados.documentos_utilizados || 'N√£o informado'}</div>
                </div>
            `;
            
            html += `
                <div class="preview-secao">
                    <div class="preview-titulo">7. PONTOS GERAIS DE ATEN√á√ÉO NA ATIVIDADE</div>
                    <div class="preview-conteudo">${dados.pontos_atencao || 'N√£o informado'}</div>
                </div>
            `;
            
            return html;
        }
        
        function confirmarGerarPDF() {
            fecharModalPreview();
            gerarPDF();
        }
        
        async function gerarPDF() {
            const btnPDF = document.getElementById('btn-gerar-pdf');
            const textoOriginal = btnPDF.textContent;
            
            btnPDF.disabled = true;
            btnPDF.textContent = 'üìÑ Gerando PDF...';
            btnPDF.classList.remove('pulse');
            
            try {
                const response = await fetch('/api/gerar-pdf-pop/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                    body: JSON.stringify({
                        dados_pop: dadosColetas,
                        session_id: sessionId
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    adicionarMensagem('helena', `‚úì PDF gerado com sucesso!`);
                    
                    const link = document.createElement('a');
                    link.href = data.pdf_url;
                    link.download = data.arquivo;
                    link.click();
                    
                    btnPDF.textContent = '‚úì PDF Gerado!';
                    btnPDF.style.background = '#28a745';
                    
                    setTimeout(() => {
                        btnPDF.textContent = textoOriginal;
                        btnPDF.disabled = false;
                        btnPDF.style.background = '';
                    }, 3000);
                    
                } else {
                    adicionarMensagem('helena', `‚ùå Erro: ${data.error}`);
                    btnPDF.textContent = textoOriginal;
                    btnPDF.disabled = false;
                }
                
            } catch (error) {
                console.error('Erro ao gerar PDF:', error);
                adicionarMensagem('helena', '‚ùå Erro t√©cnico ao gerar PDF. Tente novamente.');
                btnPDF.textContent = textoOriginal;
                btnPDF.disabled = false;
            }
        }
        
        function limparFormulario() {
            if (confirm('Tem certeza que deseja limpar todos os dados?')) {
                document.getElementById('processo-form').reset();
                dadosColetas = {};
                
                document.querySelectorAll('.validacao-feedback').forEach(el => {
                    el.textContent = '';
                    el.className = 'validacao-feedback';
                });
                
                document.querySelectorAll('.preenchido').forEach(el => {
                    el.classList.remove('preenchido');
                });
                
                atualizarIndicadorCampos();
                atualizarProgresso(0, '0/10 - Dados limpos');
                
                adicionarMensagem('helena', 'üóëÔ∏è Formul√°rio limpo! Podemos come√ßar novamente.');
            }
        }
        
        async function reiniciarConversa() {
            if (confirm('Tem certeza que deseja reiniciar a conversa?')) {
                try {
                    localStorage.removeItem('helena_dados_backup');
                    sessionStorage.clear();
                    
                    await fetch('/api/reiniciar-conversa-helena/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                            'X-CSRFToken': getCookie('csrftoken')
                        },
                        body: `session_id=${sessionId}`
                    });
                    
                    chatContainer.innerHTML = '';
                    document.getElementById('processo-form').reset();
                    dadosColetas = {};
                    historicoCompleto = [];
                    
                    document.querySelectorAll('.validacao-feedback').forEach(el => {
                        el.textContent = '';
                        el.className = 'validacao-feedback';
                    });
                    
                    document.querySelectorAll('.preenchido').forEach(el => {
                        el.classList.remove('preenchido');
                    });
                    
                    atualizarIndicadorCampos();
                    atualizarProgresso(0, '0/10 - Vamos come√ßar!');
                    
                    sessionId = 'user_' + Date.now();
                    
                    inicializarChat();
                    
                } catch (error) {
                    console.error('Erro ao reiniciar:', error);
                    alert('Erro ao reiniciar. Recarregue a p√°gina manualmente (F5).');
                }
            }
        }
        
        function abrirModalAjuda() {
            modalAjuda.classList.add('ativo');
            
            if (ajudaChatContainer.children.length === 0) {
                adicionarMensagemAjuda('helena', 'Vi que voc√™ est√° em d√∫vida para definir alguma etapa do seu processo. Me conta o que est√° havendo. Eu vou te responder e voc√™ segue no formul√°rio. Em que etapa voc√™ est√°?');
            }
            
            ajudaInput.focus();
        }
        
        function fecharModalAjuda() {
            modalAjuda.classList.remove('ativo');
        }
        
        function abrirModalHistorico() {
            const modal = document.getElementById('modal-historico');
            const modalBody = document.getElementById('modal-historico-body');
            
            modalBody.innerHTML = '';
            
            if (historicoCompleto.length === 0) {
                modalBody.innerHTML = '<p style="text-align: center; color: #666;">Nenhuma mensagem no hist√≥rico ainda.</p>';
            } else {
                historicoCompleto.forEach((item, index) => {
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'historico-item';
                    
                    const timestamp = new Date(item.timestamp).toLocaleString('pt-BR');
                    const tipoClass = item.tipo === 'usuario' ? 'usuario' : 'helena';
                    const tipoLabel = item.tipo === 'usuario' ? 'Voc√™' : 'Helena';
                    
                    let conteudoExtra = '';
                    if (item.dados_interface) {
                        conteudoExtra = `<div style="font-size: 11px; color: #666; margin-top: 5px;">Interface: ${item.dados_interface}</div>`;
                    }
                    
                    itemDiv.innerHTML = `
                        <div class="historico-timestamp">
                            ${timestamp} - Mensagem #${index + 1}
                        </div>
                        <div>
                            <span class="historico-tipo ${tipoClass}">${tipoLabel}</span>
                        </div>
                        <div class="historico-mensagem">${item.mensagem}</div>
                        ${conteudoExtra}
                    `;
                    
                    modalBody.appendChild(itemDiv);
                });
            }
            
            modal.classList.add('ativo');
            document.body.style.overflow = 'hidden';
        }
        
        function fecharModalHistorico() {
            const modal = document.getElementById('modal-historico');
            modal.classList.remove('ativo');
            document.body.style.overflow = 'auto';
        }
        
        function exportarHistorico() {
            const dataStr = JSON.stringify(historicoCompleto, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,' + encodeURIComponent(dataStr);
            
            const exportFileDefaultName = `historico_helena_${new Date().toISOString().split('T')[0]}.json`;
            
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
            
            adicionarMensagem('helena', 'üì• Hist√≥rico exportado com sucesso!');
        }
        
        function adicionarMensagemAjuda(tipo, texto, classe = '') {
            const div = document.createElement('div');
            const id = 'msg-ajuda-' + Date.now() + Math.random();
            div.id = id;
            div.className = `mensagem ${tipo} ${classe}`;
            div.textContent = texto;
            ajudaChatContainer.appendChild(div);
            ajudaChatContainer.scrollTop = ajudaChatContainer.scrollHeight;
            return id;
        }
        
        async function enviarMensagemAjuda() {
            const mensagem = ajudaInput.value.trim();
            if (!mensagem || processandoAjuda) return;
            
            processandoAjuda = true;
            enviarAjudaBtn.disabled = true;
            enviarAjudaBtn.textContent = 'Enviando...';
            
            adicionarMensagemAjuda('usuario', mensagem);
            ajudaInput.value = '';
            
            const loadingId = adicionarMensagemAjuda('helena', 'Pensando...', 'loading');
            
            try {
                const response = await fetch('/api/helena-mapeamento/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                    body: JSON.stringify({
                        message: mensagem,
                        contexto: 'ajuda_mapeamento',
                        session_id: ajudaSessionId,
                        dados_atuais: dadosColetas
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const data = await response.json();
                
                document.getElementById(loadingId)?.remove();
                
                adicionarMensagemAjuda('helena', data.resposta || 'Desculpe, n√£o consegui processar sua pergunta.');
                
            } catch (error) {
                console.error('Erro na ajuda:', error);
                document.getElementById(loadingId)?.remove();
                adicionarMensagemAjuda('helena', '‚ùå Erro ao buscar ajuda. Tente novamente.');
            } finally {
                processandoAjuda = false;
                enviarAjudaBtn.disabled = false;
                enviarAjudaBtn.textContent = 'Enviar';
                ajudaInput.focus();
            }
        }
        
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        
        async function validarCampoServidor(campo, valor) {
            const campoId = campo.id || campo.name || 'campo_desconhecido';
            const validacaoDiv = campo.parentElement.querySelector('.validacao-servidor') || criarDivValidacaoServidor(campo.parentElement);
            
            validacaoDiv.textContent = 'Validando...';
            validacaoDiv.className = 'validacao-servidor validando';
            
            try {
                const response = await fetch('/api/validar-dados-pop/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                    body: JSON.stringify({
                        campo: campoId,
                        valor: valor
                    })
                });
                
                const data = await response.json();
                
                if (data.valido) {
                    validacaoDiv.textContent = '‚úì Validado';
                    validacaoDiv.className = 'validacao-servidor valido-servidor';
                    setTimeout(() => {
                        validacaoDiv.style.display = 'none';
                    }, 3000);
                } else {
                    validacaoDiv.textContent = data.mensagem || '‚úó Inv√°lido';
                    validacaoDiv.className = 'validacao-servidor invalido-servidor';
                }
                
                return data;
                
            } catch (error) {
                console.error('Erro na valida√ß√£o:', error);
                validacaoDiv.textContent = 'Erro ao validar';
                validacaoDiv.className = 'validacao-servidor invalido-servidor';
                return { valido: true, mensagem: 'Erro na valida√ß√£o' };
            }
        }
        
        function criarDivValidacaoServidor(parent) {
            const div = document.createElement('div');
            div.className = 'validacao-servidor';
            parent.appendChild(div);
            return div;
        }
        
        async function obterSugestoes(campo, contexto = '') {
            try {
                const response = await fetch('/api/consultar-rag-sugestoes/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                    body: JSON.stringify({
                        campo: campo,
                        area: dadosColetas.area?.nome || '',
                        contexto: contexto
                    })
                });
                
                const data = await response.json();
                
                if (data.success && data.sugestoes.length > 0) {
                    const sugestoesTexto = data.sugestoes.join('\n\n');
                    adicionarMensagem('helena', `üí° Sugest√µes para ${campo}:\n\n${sugestoesTexto}`);
                }
                
            } catch (error) {
                console.error('Erro ao obter sugest√µes:', error);
            }
        }
        
        document.addEventListener('DOMContentLoaded', function() {
            userInput.focus();
            
            document.querySelectorAll('input, textarea').forEach(campo => {
                campo.addEventListener('focus', function() {
                    if (this.value.trim() === '' && dadosColetas.area) {
                        const campoNome = this.id.replace('_', ' ');
                        obterSugestoes(campoNome);
                    }
                });
            });
            
            setInterval(() => {
                if (Object.keys(dadosColetas).length > 0) {
                    localStorage.setItem('helena_dados_backup', JSON.stringify(dadosColetas));
                }
            }, 30000);
            
            const backup = localStorage.getItem('helena_dados_backup');
            if (backup) {
                try {
                    const dadosBackup = JSON.parse(backup);
                    if (confirm('Encontrei dados salvos anteriormente. Deseja recuper√°-los?')) {
                        dadosColetas = dadosBackup;
                        preencherFormulario(dadosBackup);
                    }
                } catch (e) {
                    console.error('Erro ao recuperar backup:', e);
                }
            }
        });
    </script>
</body>
</html>